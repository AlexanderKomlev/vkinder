from vk_api.longpoll import VkLongPoll, VkEventType
from vk_api.keyboard import VkKeyboard, VkKeyboardColor
from vk_api.utils import get_random_id
from datetime import datetime as dt
from dotenv import load_dotenv
from db.vkinder_db_main import (write_users, write_black_list, check_black, check_favorite, check_user_bot,
                                show_favorites, get_offset, write_parametr_offset, write_favorite, change_offset)


import vk_api
import requests
import logging
import os


logging.basicConfig(level=logging.DEBUG,
                    filename='logfile.log',
                    encoding='utf-8',
                    filemode='a',
                    format='%(asctime)s - %(levelname)s - %(message)s')
load_dotenv()


class VKinderBot:

    def __init__(self):

        self.bot_token = os.getenv('BOT_TOKEN')
        self.app_token = os.getenv('APP_TOKEN')
        self.base_url = "https://api.vk.com/method"
        self.vk_group_session = vk_api.VkApi(token=self.bot_token)
        self.longpoll = VkLongPoll(self.vk_group_session)
        self.session = vk_api.VkApi(token=self.app_token)
        self.common_params = {'access_token': self.app_token, 'v': 5.131}
        self.offset = 0
        self.current_iter = None
        logging.info('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Å–∞ VKinderBot')

    def _get_photos_list(self, user_id: int) -> list:
        '''–ü–æ–ª—É—á–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∞–ª—å–±–æ–º–∞ profile'''

        params = self.common_params
        params.update({
            'access_token': self.app_token,
            'owner_id': user_id,
            'album_id': 'profile',
            'extended': 1
        })
        response = requests.get(f'{self.base_url}/photos.get', params=params)
        logging.info('–ó–∞–≤–µ—Ä—à–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π')

        return response.json().get('response', {}).get('items', [])

    def _get_needed_photos(self, user_id: int) -> list or str:
        '''–û—Ç–±–∏—Ä–∞–µ—Ç —Ç—Ä–∏ —Å–∞–º—ã—Ö –ø–æ–ø–æ–ª—è—Ä–Ω—ã—Ö –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ª–∞–π–∫–æ–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏'''

        photos_list = self._get_photos_list(user_id)
        if not photos_list:
            return "There's no profile photo"
        photos_list.sort(key=lambda dictionary: dictionary['likes']['count'], reverse=True)
        photo_id_list = []
        for item in photos_list[:3]:
            photo_id_list.append(f'photo{item.get("owner_id")}_{item.get("id")}')

        return ",".join(photo_id_list)

    def _user_data(self, user_id) -> dict:
        '''–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –±–æ—Ç–∞'''

        params = self.common_params
        params.update({
            'user_ids': user_id,
            'fields': 'city,sex'
        })
        response = requests.get(f'{self.base_url}/users.get', params=params)
        response = response.json().get('response', {})[0]
        user = {
            'user_id': response.get('id'),
            'fullname': response.get('first_name') + ' ' + response.get('last_name'),
            'gender': response.get('sex'),
            'age': None,
            'city': None
        }
        try:
            age = (dt.date(dt.today()) - dt.date(dt.strptime(response.get('bdate'), '%d.%m.%Y'))).days / 365
        except TypeError:
            age = None
        try:
            city = response.get('city').get('title')
        except AttributeError:
            city = None
        user.update({"age": age, "city": city})

        return user

    def _search(self, params: dict, offset: int) -> list:
        '''–û—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø–æ–∏—Å–∫ –ª—é–¥–µ–π –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º'''

        method = "users.search"
        age = params.get("age")
        params = {
            "count": 20,
            "offset": offset,
            "hometown": params.get("city"),
            "sex": 1 if params.get("gender") == 2 else 2,
            "age_from": age - 3 if age else "",
            "age_to": age + 3 if age else "",
            "fields": "status"
        }
        response = self.session.method(method, values=params)
        logging.info('–ü–æ–∏—Å–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ')

        return list(filter(lambda x: x.get("is_closed", "") is False, response.get("items", "")))

    def _get_name(self, user_id):
        '''–ü–æ–ª—É—á–∞–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'''

        method = "users.get"
        params = {
                'user_ids': user_id
            }
        result = self.session.method(method, params)[0]

        return result.get("first_name")

    def filter_search(self, params: dict, offset: int) -> list:
        '''–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –ª—é–¥—è–º'''

        list_to_iter = []
        people = self._search(params, offset)
        for user in people:
            dictionary = {"fullname": f"{user.get('first_name')} {user.get('last_name')}",
                          "user_id": user.get('id'),
                          "link": f"https://vk.com/id{user.get('id')}",
                          "photos": self._get_needed_photos(user.get('id', ''))}
            list_to_iter.append(dictionary)

        return list_to_iter

    def _send_message(self, id: int, message: str, keyboard=None, attachment=None):
        '''–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–æ—Ç–∞'''

        self.vk_group_session.method('messages.send', {'user_id': id,
                                                       'message': message,
                                                       'random_id': get_random_id(),
                                                       'keyboard': keyboard,
                                                       'attachment': attachment})
        logging.info(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message}')

    def _send_start_keyboard(self):
        '''–î–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é'''

        keyboard = VkKeyboard(inline=False, one_time=True)
        keyboard.add_button("–Ω–∞—á–∞—Ç—å", color=VkKeyboardColor.PRIMARY)

        return keyboard.get_keyboard()

    def _send_full_keyboard(self, favorite_flag):
        '''–î–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é'''

        if favorite_flag:
            keyboard = VkKeyboard(inline=False)
            keyboard.add_button("–Ω–∞–∑–∞–¥", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("–≤–ø–µ—Ä–µ–¥", color=VkKeyboardColor.PRIMARY)
            keyboard.add_line()
            keyboard.add_button("–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("–≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫", color=VkKeyboardColor.SECONDARY)
            keyboard.add_button("–∑–∞–≤–µ—Ä—à–∏—Ç—å", color=VkKeyboardColor.SECONDARY)
            keyboard.add_line()
            keyboard.add_button("–ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", color=VkKeyboardColor.POSITIVE)
        else:
            keyboard = VkKeyboard(inline=False)
            keyboard.add_button("–Ω–∞–∑–∞–¥", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("–≤–ø–µ—Ä–µ–¥", color=VkKeyboardColor.PRIMARY)
            keyboard.add_line()
            keyboard.add_button("–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", color=VkKeyboardColor.PRIMARY)
            keyboard.add_button("–≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫", color=VkKeyboardColor.SECONDARY)
            keyboard.add_button("–∑–∞–≤–µ—Ä—à–∏—Ç—å", color=VkKeyboardColor.SECONDARY)

        return keyboard.get_keyboard()

    def _send_continue_complete_keyboard(self):
        '''–î–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é'''

        keyboard = VkKeyboard(inline=False)
        keyboard.add_button("–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", color=VkKeyboardColor.PRIMARY)
        keyboard.add_button("–∑–∞–≤–µ—Ä—à–∏—Ç—å", color=VkKeyboardColor.SECONDARY)

        return keyboard.get_keyboard()

    def _send_person(self, favorite_flag, person, event):
        self._send_message(event.user_id,
                           message=f"{person.get('fullname')}\n{person.get('link')}",
                           attachment=person.get("photos"),
                           keyboard=self._send_full_keyboard(favorite_flag))

    def _first_event(self, event):

        params_of_user = self._user_data(event.user_id)
        if not check_user_bot(event.user_id):
            write_users(**params_of_user)
            logging.info('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–Ω–µ—Å–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö')
        self.current_iter = BotIter(params_of_user, get_offset(event.user_id), self.filter_search)
        self._send_message(event.user_id,
                           message=f'–ü—Ä–∏–≤–µ—Ç, {self._get_name(event.user_id)}! –ú—ã –ø–æ–¥–æ–±—Ä–∞–ª–∏ –¥–ª—è —Ç–µ–±—è –ø–∞—Ä—ã. –ñ–º–∏ –Ω–∞—á–∞—Ç—å üëá',
                           keyboard=self._send_start_keyboard())

    def _begin_event(self, favorite_flag, current_iter, event):

        logging.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ –≤–µ—Ç–∫–µ "–Ω–∞—á–∞—Ç—å"')
        person = next(current_iter)
        self._send_person(favorite_flag, person, event)
        return person

    def _blacklist_event(self, person, event):

        logging.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ –≤–µ—Ç–∫–µ "–≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫"')
        if not check_black(person.get("user_id")):
            data_for_table = {
                "fullname": person.get("fullname"),
                "black_id": person.get("user_id"),
                "user_id": event.user_id
            }
            write_black_list(**data_for_table)
            logging.info('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ë–î –≤ —Ç–∞–±–ª–∏—Ü—É "black_list"')
        self._send_message(event.user_id,
                           message=f"–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ {person.get('fullname')}")

    def _favorites_event(self, favorite_flag, person, event):

        logging.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ –≤–µ—Ç–∫–µ "–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"')
        favorite_flag = favorite_flag
        if not check_favorite(person.get("user_id")):
            favorite_flag = True
            data_for_table = {
                "fullname": person.get("fullname"),
                "favorite_id": person.get("user_id"),
                "link": person.get("link"),
                "photos": person.get("photos"),
                "user_id": event.user_id
            }
            write_favorite(**data_for_table)
            logging.info('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ë–î –≤ —Ç–∞–±–ª–∏—Ü—É "favorite"')
        self._send_message(event.user_id,
                           message=f"–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ {person.get('fullname')}")
        return favorite_flag

    def _back_event(self, favorite_flag, event):

        logging.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ –≤–µ—Ç–∫–µ "–Ω–∞–∑–∞–¥"')
        person = self.current_iter.prev()
        self._send_person(favorite_flag, person, event)

    def _view_favorites_event(self, event):

        logging.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ –≤–µ—Ç–∫–µ "–ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"')
        self._send_message(event.user_id,
                           message=f"–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º")
        for user in show_favorites(event.user_id):
            self._send_message(event.user_id,
                               message=f"{user[0]}\n{user[1]}",
                               attachment=user[2])
        logging.info('–í—ã–≤–µ–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "favorite"')
        self._send_message(event.user_id,
                           message="–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å",
                           keyboard=self._send_continue_complete_keyboard())

    def _end_event(self, event):

        logging.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ –≤–µ—Ç–∫–µ "–∑–∞–≤–µ—Ä—à–∏—Ç—å"')
        self._send_message(event.user_id,
                           message=f"–î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á!")
        self.offset = self.current_iter.inner_cursor + self.current_iter.offset
        if get_offset(event.user_id):
            change_offset(event.user_id, self.offset)
        else:
            data_for_table = {
                "offset": self.offset,
                "user_id": event.user_id
            }
            write_parametr_offset(**data_for_table)

    def run_bot(self):
        '''–í—ã–ø–æ–ª—è–Ω–µ—Ç –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞'''

        logging.debug('–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞')
        person = None
        favorite_flag = False
        welcome_flag = True
        for event in self.longpoll.listen():
            if event.type == VkEventType.MESSAGE_NEW and event.to_me and event.text:
                if welcome_flag:
                    if event.text.lower():
                        self._first_event(event)
                        welcome_flag = False
                else:
                    if event.text.lower() == '–Ω–∞—á–∞—Ç—å':
                        person = self._begin_event(favorite_flag, self.current_iter, event)

                    elif event.text.lower() in ["–≤–ø–µ—Ä–µ–¥", "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", "–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", "–≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫"]:
                        if event.text.lower() == "–≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫":
                            self._blacklist_event(person, event)

                        if event.text.lower() == "–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ":
                            favorite_flag = self._favorites_event(favorite_flag, person, event)

                        person = next(self.current_iter)
                        self._send_person(favorite_flag, person, event)

                    elif event.text.lower() == '–Ω–∞–∑–∞–¥':
                        self._back_event(favorite_flag, event)

                    elif event.text.lower() == "–ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ":
                        self._view_favorites_event(event)

                    elif event.text.lower() == "–∑–∞–≤–µ—Ä—à–∏—Ç—å":
                        self._end_event(event)
                        break


class BotIter:

    def __init__(self, params_of_user, offset, search_func):

        self.search_func = search_func
        self.params = params_of_user
        self.offset = offset
        self.users = self.search_func(self.params, self.offset)
        self.stop_offset = 1000
        self.inner_cursor = -1
        logging.info('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞')

    def __iter__(self):
        return self

    def __next__(self):

        self.inner_cursor += 1
        if self.inner_cursor >= len(self.users):
            self.inner_cursor = 0
            self.offset += len(self.users)
            self.users = self.search_func(self.params, self.offset)
        if self.offset >= self.stop_offset:
            raise StopIteration
        return self.users[self.inner_cursor]

    def prev(self):

        self.inner_cursor -= 1
        if self.inner_cursor < 0:
            return self.users[0]
        return self.users[self.inner_cursor]
